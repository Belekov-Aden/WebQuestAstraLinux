{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Интерактивный терминал</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            color: #0f0;
            font-family: monospace;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal {
            background: #111;
            border: 1px solid #0f0;
            padding: 30px;
            text-align: center;
            max-width: 500px;
            color: #0f0;
            font-size: 18px;
        }
        .modal p {
            margin-bottom: 20px;
        }
        .pill-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .pill-button {
            border: none;
            padding: 10px 20px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
        }
        .blue-pill {
            background: blue;
        }
        .red-pill {
            background: red;
        }
        .green-pill {
            background: #00f000;
        }
        .terminal-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .terminal {
            border: 1px solid #0f0;
            padding: 20px;
            background: #000;
            min-height: 400px;
            position: relative;
        }
        .input-line {
            display: flex;
            align-items: center;
        }
        .prompt {
            margin-right: 5px;
        }
        .terminal-input {
            background: transparent;
            border: none;
            color: #0f0;
            font-size: 16px;
            flex: 1;
        }
        .terminal-input:focus {
            outline: none;
        }
        .output {
            white-space: pre-wrap;
            margin-bottom: 10px;
        }
        .tasks {
            width: 300px;
            border-left: 1px solid #0f0;
            padding: 20px;
            overflow-y: auto;
        }
        .tasks h2 {
            margin-top: 0;
        }
        .task {
            margin-bottom: 20px;
        }
        .task.active {
            font-weight: bold;
            color: #ff0;
        }
        .congrats {
            color: #ff0;
            font-weight: bold;
        }
    </style>
</head>
<body>

<!-- Модальное окно выбора таблетки -->
<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <div class="pill-buttons">
            <button id="blue-pill" class="pill-button blue-pill">Вернуться на рабочий стол</button>
            <button id="red-pill" class="pill-button red-pill">Продолжить</button>
        </div>
    </div>
</div>

<!-- Модальное окно проигрыша -->
<div id="lose-overlay" class="modal-overlay" style="display:none;">
    <div class="modal">
        <p>У вас закончились попытки. Вы проиграли!</p>
        <button id="lose-exit" class="pill-button green-pill">Выход</button>
    </div>
</div>

<!-- Модальное окно победы -->
<div id="win-overlay" class="modal-overlay" style="display:none;">
    <div class="modal">
        <p>Поздравляем!!! Ты прошел второй этап, твоя награда - «Токен Командной Строки», подтверждающая освоение базового функционала терминала.</p>
        <div class="pill-buttons">
            <button id="win-exit" class="pill-button green-pill">Вперед</button>
        </div>
    </div>
</div>

<div class="terminal-container">
    <div id="terminal" class="terminal">
        <div id="terminal-output"></div>
        <div class="input-line">
            <span id="prompt" class="prompt">admpc@astra-2-12:~$</span>
            <input type="text" id="terminal-input" class="terminal-input" autofocus>
        </div>
    </div>
</div>
<div class="tasks">
    <h2>Задания</h2>
    <div id="task-container"></div>
</div>

<script>
    // Функция для показа модального окна проигрыша
    function showLoseModal() {
        document.getElementById('lose-overlay').style.display = 'flex';
    }
    document.getElementById('lose-exit').addEventListener('click', function () {
        window.location.href = "{% url 'stage_seven' %}";
    });

    // Функция для показа модального окна победы
    function showWinModal() {
        document.getElementById('win-overlay').style.display = 'flex';
    }
    document.getElementById('win-exit').addEventListener('click', function () {
        window.location.href = "{% url 'stage_seven' %}";
    });

    // Кнопки выбора таблетки
    document.getElementById('blue-pill').addEventListener('click', function () {
        window.location.href = "{% url 'stage_seven' %}";
    });
    document.getElementById('red-pill').addEventListener('click', function () {
        document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById("terminal-input").focus();
    });

    // Пример файловой системы и терминальной логики (упрощенно)
    let currentDir = "admpc@astra-2-12:~$";
    function updatePrompt() {
        document.getElementById("prompt").textContent = currentDir + " $";
    }
    updatePrompt();

    function appendOutput(text, cssClass = "") {
        const outputDiv = document.getElementById("terminal-output");
        let line = document.createElement("div");
        line.className = "output " + cssClass;
        line.textContent = text;
        outputDiv.appendChild(line);
        const terminal = document.getElementById("terminal");
        terminal.scrollTop = terminal.scrollHeight;
    }

    // Простейшая симуляция команд
    function executeCommand(cmd) {
        cmd = cmd.trim();
        if (cmd.toLowerCase() === "pwd") {
            return currentDir;
        } else if (cmd.toLowerCase().startsWith("ls")) {
            // Проверка условия для Токена Командной Строки
            if (localStorage.getItem("terminalTokenActive") === "true" && cmd.toLowerCase() === "ls") {
                localStorage.removeItem("terminalTokenActive");
                localStorage.setItem("terminalTokenCompleted", "true");
                appendOutput("Поздравляем! Команда выполнена успешно!", "congrats");
                showWinModal();
                return "";
            }
            return "Содержимое каталога: ..."; // Возвращаем некий результат ls
        } else if (cmd.toLowerCase().startsWith("cd ")) {
            // Простая смена директории
            currentDir = "admpc@astra-2-12:~$" + cmd.slice(3).trim();
            updatePrompt();
            return "";
        } else {
            return "Команда не найдена";
        }
    }

    function processCommand(command) {
        command = command.trim();
        if (!command) return;
        appendOutput(document.getElementById("prompt").textContent + " " + command);
        const simOutput = executeCommand(command);
        if (simOutput) {
            appendOutput(simOutput);
        }
    }

    document.getElementById("terminal-input").addEventListener("keydown", function (e) {
        if (e.key === "Enter") {
            e.preventDefault();
            processCommand(this.value);
            this.value = "";
        }
    });
</script>
</body>
</html>
